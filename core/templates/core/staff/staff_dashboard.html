{% extends 'core/shared/base.html' %}
{% block title %}Dashboard Staff{% endblock %}
{% block content %}

<style>
    /* Override warna global agar Tab terlihat */
    .nav-pills .nav-link {
        color: #2F4F4F !important; /* Hijau Gelap saat tidak aktif */
        background-color: #fff;
        border: 1px solid #dee2e6;
    }
    
    /* Warna saat Tab Aktif/Diklik */
    .nav-pills .nav-link.active {
        background-color: #2F4F4F !important; /* Background Hijau */
        color: #fff !important; /* Teks Putih */
        border-color: #2F4F4F;
    }

    /* Efek Hover */
    .nav-pills .nav-link:hover {
        background-color: #e9ecef;
        color: #1e3333 !important;
    }
</style>

<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-1">Dashboard Operasional</h2>
            <p class="text-muted">Halo, {{ user.first_name|default:user.username }}! Semangat bekerja.</p>
        </div>
        <a href="{% url 'staff_input_walkin' %}" class="btn btn-dark shadow-sm">
            <i class="bi bi-plus-circle me-2"></i>Input Walk-in
        </a>
    </div>

    <ul class="nav nav-pills mb-4 gap-2" id="pills-tab" role="tablist">
        
        <li class="nav-item" role="presentation">
            <button class="nav-link active fw-bold border" id="pills-final-tab" data-bs-toggle="pill" data-bs-target="#pills-final" type="button">
                ðŸš€ Butuh Finalisasi 
                <span class="badge bg-danger ms-2">{{ siap_finalisasi.count }}</span>
            </button>
        </li>

        <li class="nav-item" role="presentation">
            <button class="nav-link fw-bold border" id="pills-verif-tab" data-bs-toggle="pill" data-bs-target="#pills-verif" type="button">
                Verifikasi
                {% if antrean_verifikasi.count > 0 %}
                <span class="badge bg-warning text-dark ms-2">{{ antrean_verifikasi.count }}</span>
                {% endif %}
            </button>
        </li>

        <li class="nav-item" role="presentation">
            <button class="nav-link fw-bold border" id="pills-bayar-tab" data-bs-toggle="pill" data-bs-target="#pills-bayar" type="button">
                Menunggu Bayar
                {% if menunggu_pembayaran.count > 0 %}
                <span class="badge bg-secondary ms-2">{{ menunggu_pembayaran.count }}</span>
                {% endif %}
            </button>
        </li>

        <li class="nav-item" role="presentation">
            <button class="nav-link fw-bold border" id="pills-tugas-tab" data-bs-toggle="pill" data-bs-target="#pills-tugas" type="button">
                Siap Ditugaskan
                {% if antrean_penugasan.count > 0 %}
                <span class="badge bg-info text-dark ms-2">{{ antrean_penugasan.count }}</span>
                {% endif %}
            </button>
        </li>

        <li class="nav-item" role="presentation">
            <button class="nav-link fw-bold border" id="pills-monitor-tab" data-bs-toggle="pill" data-bs-target="#pills-monitor" type="button">
                Sedang Berjalan
                <span class="badge bg-secondary ms-2">{{ sedang_berjalan.count }}</span>
            </button>
        </li>
    </ul>

    <div class="tab-content" id="pills-tabContent">

        <div class="tab-pane fade show active" id="pills-final">
            <div class="card shadow-sm border-0">
                <div class="card-body p-0">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-4">Kode</th>
                                <th>Petugas Lapangan</th>
                                <th>Status Terkini</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in siap_finalisasi %}
                            <tr>
                                <td class="ps-4 fw-bold">{{ item.kode_permohonan }}</td>
                                <td>{{ item.karyawan.nama }}</td>
                                <td class="text-primary fw-bold">{{ item.status_proses }}</td>
                                <td>
                                    <a href="{% url 'finalisasi_permohonan' item.id %}" class="btn btn-success btn-sm fw-bold" onclick="return confirm('Yakin dokumen fisik sudah diterima?')">
                                        âœ… Terima & Selesaikan
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="4" class="text-center py-5 text-muted">Tidak ada dokumen yang perlu difinalisasi.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="pills-verif">
            <div class="card shadow-sm border-0">
                <div class="card-body p-0">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-4">Kode</th>
                                <th>Pelanggan</th>
                                <th>Layanan</th>
                                <th>Tanggal</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in antrean_verifikasi %}
                            <tr>
                                <td class="ps-4 fw-bold">{{ item.kode_permohonan }}</td>
                                <td>
                                    {{ item.pelanggan.nama }}<br>
                                    <small class="text-muted">{{ item.metode_pengiriman }}</small>
                                </td>
                                <td>{{ item.layanan.nama_layanan }}</td>
                                <td>{{ item.created_at|date:"d/m/Y H:i" }}</td>
                                <td>
                                    <a href="{% url 'verifikasi_permohonan' item.id %}" class="btn btn-primary btn-sm">
                                        Proses Verifikasi
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="5" class="text-center py-5 text-muted">Antrean verifikasi kosong.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="pills-bayar">
            <div class="card shadow-sm border-0">
                <div class="card-body p-0">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="table-secondary">
                            <tr>
                                <th class="ps-4">Kode</th>
                                <th>Pelanggan</th>
                                <th>Tagihan</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in menunggu_pembayaran %}
                            <tr>
                                <td class="ps-4 fw-bold">{{ item.kode_permohonan }}</td>
                                <td>
                                    {{ item.pelanggan.nama }}<br>
                                    <a href="https://wa.me/{{ item.pelanggan.no_whatsapp }}" target="_blank" class="text-success text-decoration-none small">
                                        <i class="bi bi-whatsapp"></i> Hubungi
                                    </a>
                                </td>
                                <td>
                                    <span class="fw-bold text-dark">Rp {{ item.tagihan.total_biaya }}</span><br>
                                    <small class="text-muted">Invoice: {{ item.tagihan.nomor_invoice }}</small>
                                </td>
                                <td>
                                    <a href="{% url 'verifikasi_permohonan' item.id %}" class="btn btn-outline-secondary btn-sm">
                                        âœŽ Edit Tagihan
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="4" class="text-center py-5 text-muted">Tidak ada yang menunggu pembayaran.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="pills-tugas">
            <div class="card shadow-sm border-0">
                <div class="card-body p-0">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-4">Kode</th>
                                <th>Layanan</th>
                                <th>Pembayaran</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in antrean_penugasan %}
                            <tr>
                                <td class="ps-4 fw-bold">{{ item.kode_permohonan }}</td>
                                <td>{{ item.layanan.nama_layanan }}</td>
                                <td>
                                    <span class="badge bg-success">Lunas</span><br>
                                    <small class="text-muted">Rp {{ item.tagihan.total_biaya }}</small>
                                </td>
                                <td>
                                    <a href="{% url 'tugaskan_staff' item.id %}" class="btn btn-info text-white btn-sm">
                                        ðŸ‘® Tugaskan Staff
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="4" class="text-center py-5 text-muted">Belum ada permohonan yang lunas.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="pills-monitor">
            <div class="card shadow-sm border-0">
                <div class="card-body p-0">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-4">Kode</th>
                                <th>Petugas Lapangan</th>
                                <th>Status Terkini</th>
                                <th>Update Terakhir</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in sedang_berjalan %}
                            <tr>
                                <td class="ps-4 fw-bold">{{ item.kode_permohonan }}</td>
                                <td>{{ item.karyawan.nama }}</td>
                                <td><span class="badge bg-secondary">{{ item.status_proses }}</span></td>
                                <td>{{ item.updated_at|timesince }} yang lalu</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="4" class="text-center py-5 text-muted">Tidak ada aktivitas lapangan saat ini.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}
